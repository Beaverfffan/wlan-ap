From 498941630176e2e94faee1bcccac8ddd9c8eec17 Mon Sep 17 00:00:00 2001
From: Tim-cy Yang <Tim-cy.Yang@mediatek.com>
Date: Fri, 8 Nov 2024 10:42:40 +0800
Subject: [PATCH] mediatek-sdk: sbc remove dm device before sysupgrade

Signed-off-by: Tim-cy Yang <Tim-cy.Yang@mediatek.com>
---
 package/base-files/files/lib/upgrade/nand.sh | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/package/base-files/files/lib/upgrade/nand.sh b/package/base-files/files/lib/upgrade/nand.sh
index d910bf1791..cd7cbd06e3 100644
--- a/package/base-files/files/lib/upgrade/nand.sh
+++ b/package/base-files/files/lib/upgrade/nand.sh
@@ -422,6 +422,11 @@ nand_do_restore_config() {
 nand_do_upgrade() {
 	local file="$1"
 
+	if [ -b /dev/dm-0 ]; then
+		v "Detach all device mapper devices"
+		dmsetup remove_all
+	fi
+
 	sync
 	nand_do_flash_file "$file" && nand_do_upgrade_success
 	nand_do_upgrade_failed
-- 
2.45.2

